# app.py
import streamlit as st
import pandas as pd
from datetime import datetime
import bcrypt
import sqlalchemy as sa
from sqlalchemy import Column, Integer, String, Table, MetaData, ForeignKey
from PIL import Image, ImageStat
import numpy as np
import os

# ML imports
try:
    import tensorflow as tf
    TF_AVAILABLE = True
except Exception:
    TF_AVAILABLE = False

# ---------- Page config ----------
st.set_page_config(page_title="Ø³ÛŒØ¨ØªÚ© ğŸ Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù‡Ø§Ù„", page_icon="ğŸ", layout="wide")

# ---------- CSS ----------
st.markdown("""
<style>
html, body, [class*="css"] {
    direction: rtl !important;
    text-align: right !important;
    font-family: 'Vazirmatn', sans-serif;
    background-color: #e6f2e6;
}
.stButton>button {
    cursor: pointer;
    background-color: #4CAF50;
    color: white;
    border-radius: 8px;
    padding: 8px 16px;
    font-weight: bold;
}
.stButton>button:hover { background-color: #45a049; }
.card {
    background-color: #ffffff;
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    margin-bottom: 15px;
}
.card h3 { margin: 0; }
.card .metric { font-size: 24px; font-weight: bold; }
</style>
""", unsafe_allow_html=True)

# ---------- Database setup ----------
DB_FILE = "users_data.db"
engine = sa.create_engine(f"sqlite:///{DB_FILE}", connect_args={"check_same_thread": False})
meta = MetaData()

users_table = Table('users', meta,
    Column('id', Integer, primary_key=True),
    Column('username', String, unique=True, nullable=False),
    Column('password_hash', String, nullable=False)
)
measurements = Table('measurements', meta,
    Column('id', Integer, primary_key=True),
    Column('user_id', Integer, ForeignKey('users.id')),
    Column('date', String),
    Column('height', Integer),
    Column('leaves', Integer),
    Column('notes', String),
    Column('prune_needed', Integer)
)
schedule_table = Table('schedule', meta,
    Column('id', Integer, primary_key=True),
    Column('user_id', Integer, ForeignKey('users.id')),
    Column('task', String),
    Column('date', String),
    Column('notes', String)
)
predictions_table = Table('predictions', meta,
    Column('id', Integer, primary_key=True),
    Column('user_id', Integer, ForeignKey('users.id')),
    Column('file_name', String),
    Column('result', String),
    Column('confidence', String),
    Column('date', String)
)
disease_table = Table('disease', meta,
    Column('id', Integer, primary_key=True),
    Column('user_id', Integer, ForeignKey('users.id')),
    Column('note', String),
    Column('date', String)
)
meta.create_all(engine)

# ---------- Session ----------
for key in ['user_id','username','demo_history']:
    if key not in st.session_state:
        st.session_state[key] = None if key != 'demo_history' else []

# ---------- Password helpers ----------
def hash_password(password: str) -> str:
    return bcrypt.hashpw(password.encode(), bcrypt.gensalt()).decode()
def check_password(password: str, hashed: str) -> bool:
    return bcrypt.checkpw(password.encode(), hashed.encode())

# ---------- Model ----------
MODEL_PATH = "model/seedling_model.h5"
_model = None
_model_loaded = False
if TF_AVAILABLE and os.path.exists(MODEL_PATH):
    try:
        @st.cache_resource
        def _load_model(path): return tf.keras.models.load_model(path)
        _model = _load_model(MODEL_PATH)
        _model_loaded = True
    except Exception as e:
        st.warning(f"Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¯Ù„ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯: {e}")

# ---------- Heuristic prediction ----------
def heuristic_predict(img: Image.Image):
    img = img.convert("RGB").resize((224,224))
    stat = ImageStat.Stat(img)
    mean = np.mean(stat.mean)
    arr = np.array(img).astype(int)
    r,g,b = arr[:,:,0], arr[:,:,1], arr[:,:,2]
    yellow_ratio = ((r>g)&(g>=b)).mean()
    green_ratio = ((g>r+10)&(g>b+10)).mean()
    if green_ratio>0.12 and mean>80: return "Ø³Ø§Ù„Ù…", f"{min(99,int(50+green_ratio*200))}%"
    if yellow_ratio>0.12 or mean<60:
        if yellow_ratio>0.25: return "Ø¨ÛŒÙ…Ø§Ø±", f"{min(95,int(40+yellow_ratio*200))}%"
        else: return "Ú©Ù…â€ŒØ¢Ø¨ÛŒ/Ù†ÛŒØ§Ø² Ù‡Ø±Ø³", f"{min(90,int(30+(0.2-mean/255)*200))}%"
    return "Ù†Ø§Ù…Ø´Ø®Øµ", "50%"
def predict_with_model(img: Image.Image):
    x = np.expand_dims(np.array(img.convert("RGB").resize((224,224)))/255.0,0)
    preds = _model.predict(x)
    classes = ["Ø³Ø§Ù„Ù…","Ø¨ÛŒÙ…Ø§Ø±","Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù‡Ø±Ø³","Ú©Ù…â€ŒØ¢Ø¨ÛŒ"]
    idx = int(np.argmax(preds[0]))
    confidence = int(float(np.max(preds[0]))*100)
    return classes[idx], f"{confidence}%"

# ---------- Header ----------
def app_header():
    st.markdown(f"""
    <div style='display:flex;align-items:center;margin-bottom:20px;'>
        <img src='logo.png' width='64' style='margin-left:12px;border-radius:12px;'>
        <div>
            <h2 style='margin:0'>Ø³ÛŒØ¨ØªÚ©</h2>
            <small style='color:#666'>Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ Ù¾Ø§ÛŒØ´ Ù†Ù‡Ø§Ù„</small>
        </div>
    </div><hr/>
    """, unsafe_allow_html=True)
app_header()

# ---------- Auth ----------
if st.session_state['user_id'] is None:
    col1,col2 = st.columns([1,2])
    with col1: mode = st.radio("Ø­Ø§Ù„Øª:", ["ÙˆØ±ÙˆØ¯","Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…","Ø¯Ù…Ùˆ"])
    with col2: st.write("")
    if mode=="Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…":
        st.subheader("Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯")
        username = st.text_input("Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ", key="signup_username")
        password = st.text_input("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±", type="password", key="signup_password")
        if st.button("Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…"):
            if not username or not password: st.error("Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")
            else:
                try:
                    with engine.connect() as conn:
                        sel = sa.select(users_table).where(users_table.c.username==username)
                        if conn.execute(sel).mappings().first(): st.error("Ø§ÛŒÙ† Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.")
                        else:
                            conn.execute(users_table.insert().values(username=username,password_hash=hash_password(password)))
                            st.success("Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. Ø§Ú©Ù†ÙˆÙ† ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.")
                except Exception as e: st.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: {e}")
    elif mode=="ÙˆØ±ÙˆØ¯":
        st.subheader("ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ")
        username = st.text_input("Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ", key="login_username")
        password = st.text_input("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±", type="password", key="login_password")
        if st.button("ÙˆØ±ÙˆØ¯"):
            try:
                r = engine.connect().execute(sa.select(users_table).where(users_table.c.username==username)).mappings().first()
                if not r: st.error("Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.")
                elif check_password(password,r['password_hash']):
                    st.session_state['user_id']=int(r['id'])
                    st.session_state['username']=r['username']
                    st.experimental_rerun = lambda: None
                else: st.error("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.")
            except Exception as e: st.error(f"Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: {e}")
    else:  # Demo
        st.subheader("Ø­Ø§Ù„Øª Ø¯Ù…Ùˆ â€” Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ù†Ù…ÙˆÙ†Ù‡")
        uploaded = st.file_uploader("ÛŒÚ© ØªØµÙˆÛŒØ± Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯", type=["jpg","jpeg","png"])
        if uploaded:
            img = Image.open(uploaded)
            st.image(img,use_container_width=True)
            if _model_loaded: label,conf = predict_with_model(img)
            else: label,conf = heuristic_predict(img)
            color = "#4CAF50" if "Ø³Ø§Ù„Ù…" in label else "#FF9800" if "Ú©Ù…â€ŒØ¢Ø¨ÛŒ" in label else "#F44336"
            st.markdown(f"<div class='card' style='border-left:6px solid {color};'><h3>Ù†ØªÛŒØ¬Ù‡: {label}</h3><div>Ø§Ø¹ØªÙ…Ø§Ø¯: {conf}</div></div>",unsafe_allow_html=True)

# ---------- Main app ----------
else:
    st.sidebar.header(f"Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ {st.session_state['username']}")
    menu = st.sidebar.selectbox("Ù…Ù†Ùˆ",[
        "ğŸ  Ø®Ø§Ù†Ù‡","ğŸŒ± Ù¾Ø§ÛŒØ´ Ù†Ù‡Ø§Ù„","ğŸ“… Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ","ğŸ“ˆ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ù„Ø§Ù…Øª Ù†Ù‡Ø§Ù„",
        "ğŸ Ø«Ø¨Øª Ø¨ÛŒÙ…Ø§Ø±ÛŒ / ÛŒØ§Ø¯Ø¯Ø§Ø´Øª","ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§","ğŸšª Ø®Ø±ÙˆØ¬"])
    user_id = st.session_state['user_id']

    if menu=="ğŸšª Ø®Ø±ÙˆØ¬":
        st.session_state['user_id']=None
        st.session_state['username']=None
        st.experimental_rerun = lambda: None

    # --- Home ---
    if menu=="ğŸ  Ø®Ø§Ù†Ù‡":
        st.header("Ø®Ø§Ù†Ù‡")
        with engine.connect() as conn:
            ms = conn.execute(sa.select(measurements).where(measurements.c.user_id==user_id)).mappings().all()
            ps = conn.execute(sa.select(predictions_table).where(predictions_table.c.user_id==user_id)).mappings().all()
        col1,col2 = st.columns(2)
        col1.markdown(f"<div class='card'><h3>ØªØ¹Ø¯Ø§Ø¯ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒâ€ŒÙ‡Ø§</h3><div class='metric'>{len(ms)}</div></div>",unsafe_allow_html=True)
        col2.markdown(f"<div class='card'><h3>ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒâ€ŒÙ‡Ø§</h3><div class='metric'>{len(ps)}</div></div>",unsafe_allow_html=True)

    # --- Measurements ---
    elif menu=="ğŸŒ± Ù¾Ø§ÛŒØ´ Ù†Ù‡Ø§Ù„":
        st.header("Ù¾Ø§ÛŒØ´ Ù†Ù‡Ø§Ù„ â€” Ø«Ø¨Øª Ø±Ø´Ø¯")
        with st.expander("â• Ø§ÙØ²ÙˆØ¯Ù† Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ"):
            date = st.date_input("ØªØ§Ø±ÛŒØ®",value=datetime.today())
            height = st.number_input("Ø§Ø±ØªÙØ§Ø¹ (Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±)", min_value=0, step=1)
            leaves = st.number_input("ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø±Ú¯", min_value=0, step=1)
            notes = st.text_area("ÛŒØ§Ø¯Ø¯Ø§Ø´Øª")
            prune = st.checkbox("Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù‡Ø±Ø³ØŸ")
            if st.button("Ø«Ø¨Øª Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ"):
                with engine.connect() as conn:
                    conn.execute(measurements.insert().values(user_id=user_id,date=str(date),height=int(height),leaves=int(leaves),notes=notes,prune_needed=int(prune)))
                    st.success("Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ø«Ø¨Øª Ø´Ø¯.")
        # Ù†Ù…Ø§ÛŒØ´ Ø¬Ø¯ÙˆÙ„ Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø±
        with engine.connect() as conn:
            rows = conn.execute(sa.select(measurements).where(measurements.c.user_id==user_id).order_by(measurements.c.date.desc())).mappings().all()
        if rows:
            df = pd.DataFrame(rows)
            st.subheader("ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒâ€ŒÙ‡Ø§")
            st.dataframe(df)
            try:
                df_plot = df.copy(); df_plot['date']=pd.to_datetime(df_plot['date'])
                st.line_chart(df_plot.set_index('date')['height'])
                st.line_chart(df_plot.set_index('date')['leaves'])
            except: pass
        else: st.info("Ù‡ÛŒÚ† Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒâ€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.")

    # --- Schedule ---
    elif menu=="ğŸ“… Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ":
        st.header("Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§")
        with st.expander("â• Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡"):
            task = st.text_input("ÙØ¹Ø§Ù„ÛŒØª")
            task_date = st.date_input("ØªØ§Ø±ÛŒØ® Ø¨Ø±Ù†Ø§Ù…Ù‡")
            task_notes = st.text_area("ÛŒØ§Ø¯Ø¯Ø§Ø´Øª")
            if st.button("Ø«Ø¨Øª Ø¨Ø±Ù†Ø§Ù…Ù‡"):
                with engine.connect() as conn:
                    conn.execute(schedule_table.insert().values(user_id=user_id,task=task,date=str(task_date),notes=task_notes))
                    st.success("Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø«Ø¨Øª Ø´Ø¯.")
        with engine.connect() as conn:
            rows = conn.execute(sa.select(schedule_table).where(schedule_table.c.user_id==user_id).order_by(schedule_table.c.date.desc())).mappings().all()
        if rows:
            st.subheader("Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡")
            st.dataframe(pd.DataFrame(rows))
        else: st.info("Ù‡ÛŒÚ† Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.")

    # --- Prediction ---
    elif menu=="ğŸ“ˆ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ù„Ø§Ù…Øª Ù†Ù‡Ø§Ù„":
        st.header("Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ù„Ø§Ù…Øª Ù†Ù‡Ø§Ù„")
        uploaded = st.file_uploader("Ø¢Ù¾Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± Ù†Ù‡Ø§Ù„", type=["jpg","jpeg","png"])
        if uploaded:
            img = Image.open(uploaded)
            st.image(img,use_container_width=True)
            if _model_loaded: label,conf = predict_with_model(img)
            else: label,conf = heuristic_predict(img)
            color = "#4CAF50" if "Ø³Ø§Ù„Ù…" in label else "#FF9800" if "Ú©Ù…â€ŒØ¢Ø¨ÛŒ" in label else "#F44336"
            st.markdown(f"<div class='card' style='border-left:6px solid {color};'><h3>Ù†ØªÛŒØ¬Ù‡: {label}</h3><div>Ø§Ø¹ØªÙ…Ø§Ø¯: {conf}</div></div>",unsafe_allow_html=True)
            with engine.connect() as conn:
                conn.execute(predictions_table.insert().values(user_id=user_id,file_name=getattr(uploaded,'name',str(datetime.now().timestamp())),result=label,confidence=conf,date=str(datetime.now())))
            # history
            with engine.connect() as conn:
                rows = conn.execute(sa.select(predictions_table).where(predictions_table.c.user_id==user_id).order_by(predictions_table.c.date.desc())).mappings().all()
            if rows:
                st.subheader("ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒâ€ŒÙ‡Ø§")
                st.dataframe(pd.DataFrame(rows))

    # --- Disease notes ---
    elif menu=="ğŸ Ø«Ø¨Øª Ø¨ÛŒÙ…Ø§Ø±ÛŒ / ÛŒØ§Ø¯Ø¯Ø§Ø´Øª":
        st.header("Ø«Ø¨Øª Ø¨ÛŒÙ…Ø§Ø±ÛŒ / ÛŒØ§Ø¯Ø¯Ø§Ø´Øª")
        note = st.text_area("Ø´Ø±Ø­ Ù…Ø´Ú©Ù„ ÛŒØ§ Ø¹Ù„Ø§Ø¦Ù…")
        if st.button("Ø«Ø¨Øª ÛŒØ§Ø¯Ø¯Ø§Ø´Øª"):
            with engine.connect() as conn:
                conn.execute(disease_table.insert().values(user_id=user_id,note=note,date=str(datetime.now())))
                st.success("ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø«Ø¨Øª Ø´Ø¯.")
        with engine.connect() as conn:
            rows = conn.execute(sa.select(disease_table).where(disease_table.c.user_id==user_id).order_by(disease_table.c.date.desc())).mappings().all()
        if rows:
            st.subheader("ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡")
            st.dataframe(pd.DataFrame(rows))
        else: st.info("Ù‡ÛŒÚ† ÛŒØ§Ø¯Ø¯Ø§Ø´ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.")

    # --- Download ---
    elif menu=="ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§":
        st.header("Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§")
        with engine.connect() as conn:
            rows = conn.execute(sa.select(measurements).where(measurements.c.user_id==user_id)).mappings().all()
        if rows:
            df = pd.DataFrame(rows)
            st.download_button("Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒâ€ŒÙ‡Ø§ (CSV)",df.to_csv(index=False).encode('utf-8-sig'),"measurements.csv","text/csv")
        else: st.info("Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.")
